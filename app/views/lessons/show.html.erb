
<% provide(:title, @lesson.title) %>

<div class="container">
<h1><%= @lesson.title %></h1>
</div>

</div>
<div class="container">
<div class="span7">
<% i = 1 %>

  <h2><%= i %>. Watch Video</h2>

<% i += 1 %>

  <p class="body"><%= @lesson.lessondescription %>

  <br><br>

  <% if @lesson.movies.empty? %>
    <% if current_subscriber.has_role? :admin %>
      <center>
      <p class="body">There is not currently a video associated with this module.</p>
      <%= link_to "Add Video", addmovie_path, :class => "btn btn-large btn-primary" %>
      </center>
    <% else %>
      <p class="body">There is not currently a video associated with this module.</p>
    <% end %>
  <% else %>
  <div id="myElement">Loading the player ...</div>
  <script type='text/javascript'>
    jwplayer("myElement").setup({
        file: "<%= @lesson.movies.first.movie %>",
        title: "<%= @lesson.title %>",
        width: '100%',
        aspectratio: '16:9',
        fallback: 'false',
        primary: 'flash'
        });
  </script>
  <% end %>

  <%# For background image, use image: 'IMAGE URL' #%>
  <%# primary: 'flash' %>

  <br>
  <br>

  <% unless @lesson.quiz == nil %>

  <h2><%= i %>. Take Test</h2>
  <% i += 1 %>
  
    <p class="body">
      Once you have watched the video, see how much you remember by <%= link_to "taking the test", quiz_path(@lesson.quiz), :target => "_blank" %>. Remember, you can watch the video as many times as you like if you are unsure of any of the answers. [Test will open in new tab or window]
    <p class="body">
    <strong>
      Please note: you can take the test as many times as you like, but only your first score will be counted.
    </strong>
    <br>
    <% if @sub_scores.count == 0 %>
    <center>
      <%= link_to "Take Test", @lesson.quiz, :target => "_blank", :class => "btn btn-large btn-primary" %>
    </center>
    <% else %>
    <center>
      <%= link_to "Retake Test", @lesson.quiz, :target => "_blank", :class => "btn btn-large btn-primary" %>
    </center>
    <% end %>
  <br><br>
  <% end %>



  <% unless @lesson.sources.count == 0 %>

    <h2><%= i %>. Sources</h2>
    <% i += 1 %>
     
      <ul class="sourcelist">
      <% k=1 %>
        <% @lesson.sources.each do |source| %>
          <li>

            <%= source.name %>

            <% unless source.fulltext.blank? %>
                
                <%= link_to "[Read]", 'javascript:;',
                :data => {:toggle => "collapse", :target => "#collapse_#{k}"}  %>

            <% end %>

            <% unless source.link.empty? %>
              <%= link_to "[Full Text]", source.link, :target => "_blank" %>
            <% end %>
            
            <% unless source.wikipedia.empty? %>
              <%= link_to "[Wikipedia]", source.wikipedia, :target => "_blank" %>
            <% end %>

            <% unless source.fulltext.blank? %>

            <div id="collapse_<%= k %>" class="collapse">
              <div class="span6">
              <% k+= 1 %>
              <br>
              <em><%= source.fulltext.html_safe %></em>
              <br><br>
              <p class="text-right"><%= source.reference %></p>
              <% if current_subscriber.has_role? :admin %>
              <%= link_to "Edit Source", edit_source_path(source) %>
              <% else %>
              <% end %>
              </div>
            </div>

            <% end %>

          </li>

        <% end %>
      </ul>

  <br><br>
  <% end %>

  <% unless @lesson.books.count == 0 %>

    <h2><%= i %>. Further Reading</h2>
    <% i += 1 %>
       
      <ul class="sourcelist">
      <% k=1 %>
        <% @lesson.books.each do |book| %>
          <li>

            <% unless book.section.empty? %>
              <%= book.section %> of
            <% end %>

            <%= book.author %>, <em><%= book.title %></em> (<%= book.publication_date %>) 

          </li>


        <% end %>
      </ul>

  <br><br>
  <% end %>

  <% unless @lesson.essays.count == 0 %>

  <h2><%= i %>. Discussion Questions</h2>

  <ul class="sourcelist">
        
        <% @lesson.essays.each do |essay| %>
          <li><%= essay.question %></li>
        <% end %>
  </ul>

  <% end %>


</div>




<div class="span3 offset1">
  
  <h2>Navigation</h2>
  <ul class="courselist">
  <li><i class="icon-chevron-left"></i> <%= link_to "Return to course overview", @lesson.course %></li>
  <% if @lesson == @lesson.course.lessons.first %>
  <% else %>
    <li><i class="icon-chevron-left"></i> <%= link_to "Go to previous module", lesson_path(@prev) %></li>
  <% end %>
  <% if @lesson == @lesson.course.lessons.last %>
  <% else %>
    <li><i class="icon-chevron-right"></i> <%= link_to "Go to next module", lesson_path(@next) %></li>
  <% end %>
  </ul>  

  <br><br>

  <h2>Key Files</h2>
  <ul class="courselist">
    <% if @lesson.transcripts.count == 0 && @lesson.handouts.count == 0 %>
    There are no files associated with this module.
    <% elsif @lesson.transcripts.count == 0 %>
    <li><i class="icon-file"></i> <%= link_to 'Module Handout', @lesson.handouts.first.handout.url %>
    <% elsif @lesson.handouts.count == 0 %>
    <li><i class="icon-file"></i> <%= link_to 'Module Transcript', @lesson.transcripts.first.transcript.url %></li>
    <% else %>
    <% end %>
  </ul>

  <br><br>

  <% unless @lesson.quiz == nil %>
    <h2>Test Score</h2>
      
      <% if @sub_scores.count == 0 %>
      
        <p class="body">You have not taken the test yet.</p>
      <% else %>
        <% i = 0 %>
          <% current_subscriber.scores.each do |score| %>
            <% if score.quiz.id == @lesson.quiz.id && score.subscriber_id == current_subscriber.id && i<1 %>
              <p>You scored <%= score.score %> out of <%= score.possible %> (<%= score.percentage %>%)</p>
              <% i += 1 %>
            <% else %>
            <% end %>
      <% end %>
    <% end %>
  <% end %>
  

</div>
</div>